<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Switch n' Slide</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin: 0;
      padding: 2rem;
      background: #f0f4f8;
      color: #334155;
      line-height: 1.5;
    }
    .container {
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      display: inline-block;
      min-width: 500px;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: #1e40af;
    }
    p#goal {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: #475569;
    }
     .level-selector {
       margin-bottom: 1.5rem;
       font-size: 1.1rem;
    }
    .level-selector label {
        margin: 0 0.5rem;
        cursor: pointer;
    }
    .level-selector input[type="radio"] {
        margin-right: 0.3rem;
    }
    .rules-container {
      background: #f8fafc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      min-height: 100px;
    }
    .rule {
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .rule-label {
      min-width: 130px;
      text-align: right;
      font-weight: 500;
    }
    select {
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      background-color: white;
    }
    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
      margin: 0 0.5rem;
      transition: background 0.2s;
    }
    button:hover {
      background: #1d4ed8;
    }
    #result {
      margin-top: 1.5rem;
      font-size: 1.2rem;
      font-weight: bold;
      height: 1.5em;
    }
    .success {
      color: #16a34a;
    }
    .failure {
      color: #dc2626;
    }
    #tape {
      margin: 3rem auto 1rem;
      font-family: monospace;
      position: relative;
    }
    .tape-container {
      position: relative;
      margin: 0 auto;
      /* Width set dynamically */
      height: 40px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
    }
    .tape-wrapper {
      display: block;
      /* Width set dynamically */
      height: 30px;
      position: absolute;
      top: 5px;
      left: 0;
      border-top: 1px solid #cbd5e1;
      border-bottom: 1px solid #cbd5e1;
      overflow: hidden;
    }
    .tape-inner {
      white-space: nowrap;
      transition: transform 0.3s ease-out;
      position: absolute;
      top: 0;
      left: 0;
    }
    .cell {
      display: inline-block;
      width: 28px;
      height: 28px;
      line-height: 28px;
      border: 1px solid #94a3b8;
      margin: in-block 0 1px;
      background: #fff;
      font-weight: 600;
      font-size: 1.2rem;
      text-align: center;
    }
    .cell.active {
      background: #dbeafe;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
      position: relative;
    }
    .controls {
      margin-top: 2rem;
    }
    .step-counter {
      font-size: 1.1rem;
      margin-top: 1rem;
      font-weight: 500;
    }
    .rule-header {
      font-weight: bold;
      margin-bottom: 1rem;
      color: #475569;
    }
    .state-indicator {
      font-size: 1.1rem;
      margin-top: 1rem;
      font-weight: 500;
      margin-bottom: 10px;
    }
    .current-state {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: #dbeafe;
      border-radius: 4px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Switch n' Slide</h1>

    <div class="level-selector">
      <strong>Level:</strong>
      <label><input type="radio" name="level" value="1" onclick="setupGame(1)"> 1</label>
      <label><input type="radio" name="level" value="2" onclick="setupGame(2)"> 2</label>
      <label><input type="radio" name="level" value="3" onclick="setupGame(3)" checked> 3</label>
      <label><input type="radio" name="level" value="4" onclick="setupGame(4)"> 4</label>
      <label><input type="radio" name="level" value="5" onclick="setupGame(5)"> 5</label>
      <label><input type="radio" name="level" value="6" onclick="setupGame(6)"> 6</label>
    </div>

    <p id="goal">Goal: Define rules that slide the tape exactly 3 times.</p>

    <div class="rules-container">
      <div class="rule-header">Define your rules:</div>
      <div id="rules"></div>
    </div>

    <div class="controls">
      <button onclick="runMachine()">Begin</button>
    </div>

    <div id="result"></div>
    <div class="step-counter">Slides: <span id="stepCount">0</span></div>
    <div class="state-indicator">Current Mode: <span id="currentState" class="current-state">A</span></div>

    <div id="tape">
        <div id="tape-container" class="tape-container">
          <div id="tape-wrapper" class="tape-wrapper">
            <div id="tape-inner" class="tape-inner"></div>
          </div>
        </div>
    </div>
    </div>

  <script>
    // --- Game Configuration ---
    let numStates = 2;
    let states = ['A', 'B'];
    let nextStateOptions = ['A', 'B'];
    let targetSteps = 3; // Default level 3
    let currentLevel = 3;

    const symbols = ['O', 'X'];
    const moveOptions = ['L', 'R'];
    const cellWidth = 28; // Cell width
    const cellMargin = 2; // Total margin (1px left + 1px right)
    const cellTotalWidth = cellWidth + cellMargin; // 30

    // --- Machine Execution Globals ---
    let isRunning = false;
    let machineTimeout = null;
    let currentTape = {};
    let currentHeadPosition = 0;

    // --- Setup ---
    function setupGame(level) {
        stopMachine();
        currentLevel = level;
        targetSteps = level;

        const goalText = document.getElementById('goal');
        goalText.textContent = `Goal: Define rules that slide the tape exactly ${targetSteps} time${targetSteps !== 1 ? 's' : ''}.`;

        buildUI();
        initializeTape();
        resetMachine();
    }

    function createDropdown(options, id) {
      const select = document.createElement('select');
      select.id = id;
      
      for (const option of options) {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
      }
      return select;
    }

    function buildUI() {
      const container = document.getElementById('rules');
      if (!container) {
          console.error("Rules container not found!");
          return;
      }
      container.innerHTML = '';
      
      for (const state of states) {
        for (const symbol of symbols) {
          const ruleDiv = document.createElement('div');
          ruleDiv.className = 'rule';

          const ruleLabel = document.createElement('div');
          ruleLabel.className = 'rule-label';
          ruleLabel.textContent = `Mode ${state}|${symbol}:`;
          ruleDiv.appendChild(ruleLabel);

          // Always mark X (removed mark dropdown)

          ruleDiv.appendChild(document.createTextNode("Slide "));
          const moveSel = createDropdown(moveOptions, `${state}${symbol}-move`);
          ruleDiv.appendChild(moveSel);

          ruleDiv.appendChild(document.createTextNode(" Switch to Mode "));
          const nextSel = createDropdown([...nextStateOptions, 'S'], `${state}${symbol}-next`);
          ruleDiv.appendChild(nextSel);

          container.appendChild(ruleDiv);
        }
      }
    }

    function getRule(state, symbol) {
      const moveEl = document.getElementById(`${state}${symbol}-move`);
      const nextEl = document.getElementById(`${state}${symbol}-next`);

       if (!moveEl || !nextEl) {
           console.error(`Rule elements not found for state ${state}, symbol ${symbol}`);
           return { write: 'X', move: 'R', next: state };
       }
      return { write: 'X', move: moveEl.value, next: nextEl.value };
    }

    // --- Tape Visualization ---
    function initializeTape() {
      const tapeContainer = document.getElementById('tape-container');
      const tapeWrapper = document.getElementById('tape-wrapper');
      const tapeInner = document.getElementById('tape-inner');

      if (!tapeContainer || !tapeWrapper || !tapeInner) {
          console.error("Tape elements not found during initialization!");
          return;
      }

      tapeInner.innerHTML = '';
      tapeInner.style.transform = 'translateX(0px)';

      const numVisibleCells = 2 * targetSteps + 1;
      const tapeWidth = numVisibleCells * cellTotalWidth;

      tapeContainer.style.width = `${tapeWidth}px`;
      tapeWrapper.style.width = `${tapeWidth}px`;

      for (let i = 0; i < numVisibleCells; i++) {
        const cell = document.createElement('span');
        cell.className = 'cell';
        cell.textContent = 'O';
        cell.setAttribute('data-index', i - targetSteps);
        tapeInner.appendChild(cell);
      }
    }

    function updateTape(tape, headPosition) {
        const tapeWrapper = document.getElementById('tape-wrapper');
        const tapeInner = document.getElementById('tape-inner');

        if (!tapeWrapper || !tapeInner) {
          console.error("Tape elements not found during update!");
          return;
        }
        const cells = tapeInner.querySelectorAll('.cell');
        if (cells.length === 0) {
            console.error("No cells found to update!");
            return;
        }

        const tapeWidth = parseFloat(tapeWrapper.style.width);
        const visualCenter = tapeWidth / 2;
        const centerCellIndexInDOM = Math.floor(cells.length / 2);

        // Remove 'active' class from all cells first
        cells.forEach(cell => {
            cell.classList.remove('active');
            const logicalIndex = parseInt(cell.getAttribute('data-index'));
            const value = tape[logicalIndex] || 'O';
            cell.textContent = value;
        });

        // Find and highlight the active cell
        for (let cell of cells) {
            const logicalIndex = parseInt(cell.getAttribute('data-index'));
            if (logicalIndex === headPosition) {
                cell.classList.add('active');
                break;
            }
        }

        // Center the active cell in the view
        const headCenterPosition = (headPosition + centerCellIndexInDOM) * cellTotalWidth + (cellTotalWidth / 2);
        const offset = visualCenter - headCenterPosition;
        tapeInner.style.transform = `translateX(${offset}px)`;
    }

    // --- Machine Control ---
    function stopMachine() {
         if (machineTimeout) {
            clearTimeout(machineTimeout);
            machineTimeout = null;
         }
         isRunning = false;
    }

    function resetMachine() {
      stopMachine();
      currentTape = {};
      currentHeadPosition = 0;

      document.getElementById('currentState').textContent = 'A';
      document.getElementById('result').textContent = '';
      document.getElementById('result').className = '';
      document.getElementById('stepCount').textContent = '0';

      if (document.getElementById('tape-inner')?.children.length > 0) {
           updateTape(currentTape, currentHeadPosition);
      } else {
           initializeTape();
           setTimeout(() => updateTape(currentTape, currentHeadPosition), 0);
      }
    }

    function runMachine() {
      if (isRunning) return;
      resetMachine();
      isRunning = true;

      let tape = { ...currentTape };
      let headPosition = currentHeadPosition;
      let state = 'A';
      let steps = 0;
      const maxSteps = targetSteps;

      function step() {
        if (!isRunning) return;
        const result = document.getElementById('result');

        if (state === 'S' || steps > maxSteps) {
           if (state === 'S' && steps === maxSteps) {
                result.textContent = `Success! You slid exactly ${steps} time(s).`;
                result.className = 'success';
            } else if (state === 'S' && steps < maxSteps) {
                 result.textContent = `Fail! You stopped sliding too early.`;
                 result.className = 'failure';
            } else {
                result.textContent = `Fail! You slid more than ${maxSteps} time(s).`;
                result.className = 'failure';
            }
            stopMachine();
            return;
        }

        const currentSymbol = tape[headPosition] || 'O';
        const rule = getRule(state, currentSymbol);

        tape[headPosition] = rule.write;
        headPosition += rule.move === 'R' ? 1 : -1;
        state = rule.next;
        steps++;

        document.getElementById('stepCount').textContent = steps;
        document.getElementById('currentState').textContent = state;
        updateTape(tape, headPosition);

        // Use a speed consistent with the animation time
        machineTimeout = setTimeout(step, 350);
      }
      step();
    }

    // Initialize when page loads
    window.onload = () => {
        const defaultLevel = 3;
        const radio = document.querySelector(`input[name="level"][value="${defaultLevel}"]`);
        if (radio) radio.checked = true;
        setupGame(defaultLevel);
    };
  </script>
</body>
</html>
